# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

MediaRouter is an open-source unified API gateway for AI video generation providers (OpenAI Sora, Runway, Kling AI). It provides an OpenAI-compatible API with BYOK (Bring Your Own Keys) model, built with FastAPI backend and React frontend.

## Development Commands

### Quick Start (Recommended - Uses Pre-built Images)

```bash
./setup.sh                    # Initial setup - pulls pre-built images automatically
docker compose up -d          # Start all services
docker compose down           # Stop all services
docker compose pull           # Update to latest images
docker compose restart backend   # Restart backend only
docker compose logs -f backend   # View backend logs
```

**Pre-built Docker images** are automatically pulled from GitHub Container Registry (ghcr.io). No build time required!

### Local Development (Building from Source)

For development when you need to modify code:

```bash
# Use local build compose file
docker compose -f docker-compose.local.yml up --build

# Or uncomment "build:" lines in docker-compose.yml and:
docker compose build
docker compose up -d
```

### Local Development (Without Docker)

**Backend:**
```bash
cd backend
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
python run.py  # Runs on http://localhost:3001
```

**Frontend:**
```bash
cd frontend
npm install
npm run dev  # Runs on http://localhost:5173 or :3000
```

**Backend with hot reload:**
```bash
cd backend
uvicorn src.main:app --reload --port 3001
```

### Testing

```bash
# Backend tests
cd backend
pytest

# Frontend linting
cd frontend
npm run lint

# Frontend build
npm run build
```

## Architecture Overview

### Provider System

**Adding a new video provider:**

1. Create new file in `backend/src/providers/newprovider.py`
2. Inherit from `VideoProvider` base class (see `backend/src/providers/base.py`)
3. Implement required methods:
   - `name` property
   - `models` property
   - `validate_key()` - Validate API key
   - `generate_video()` - Start video generation
   - `check_status()` - Poll generation status
   - `get_supported_features()` - Declare provider capabilities
4. Register in `backend/src/providers/__init__.py`:
   - Add to `PROVIDERS` dict
   - Add models to `MODEL_PROVIDER_MAP`

**Provider Interface:**
- All providers return normalized `VideoResponse` objects
- Background polling is handled by `process_video_generation()` in `routes.py`
- Videos are downloaded to `storage/videos/` via `video_storage.py`

### API Key Security

- Keys stored encrypted using Fernet symmetric encryption
- Encryption key from `ENCRYPTION_KEY` env var (generated by setup.sh)
- Key management in `backend/src/services/key_manager.py`
- Encryption service in `backend/src/services/encryption.py`
- **Never** commit `.env` files or encryption keys

### Video Generation Flow

1. `POST /v1/video/generations` creates `Generation` record (status: `queued`)
2. Background task in `process_video_generation()` starts provider call
3. Provider returns `job_id`, status updated to `processing`
4. Backend polls provider every 5 seconds (max 60 attempts = 5 min)
5. On completion, video downloaded to `storage/videos/{generation_id}.mp4`
6. Generation record updated with `video_url`, `video_path`, `cost`, `duration_seconds`
7. Frontend polls `GET /v1/video/generations/{id}` for status updates

### Cost Calculation

- Centralized in `backend/src/services/cost_calculator.py`
- Per-second pricing model for all providers
- Automatic cost calculation after video generation completes
- Resolution-based multipliers for accurate pricing
- Cost estimation endpoint: `POST /v1/usage/estimate`

### Database Models

**SQLAlchemy models in `backend/src/models/`:**

- `APIKey` - Encrypted provider API keys
- `Generation` - Video generation jobs (tracks status, cost, metadata)
- `UsageStat` - Aggregated usage statistics

**Database:** SQLite by default (`storage/db.sqlite`), PostgreSQL recommended for production

### Background Tasks

- FastAPI `BackgroundTasks` used for async video generation
- No Celery/Redis required for basic operation
- Long-running operations handled via polling pattern
- Max timeout: 5 minutes (60 x 5-second intervals)

## Important Technical Details

### API Routes Structure

All routes in `backend/src/api/routes.py`:
- `/v1/video/generations` - Video generation CRUD
- `/v1/keys` - API key management
- `/v1/providers` - List available providers and features
- `/v1/usage/*` - Usage statistics and cost reporting
- `/videos/{filename}` - Serve generated videos (static files)

### Frontend Structure

- React 18 + TypeScript + Vite
- shadcn/ui components in `frontend/src/components/ui/`
- Pages: `Playground.tsx` (generation), `Gallery.tsx` (videos), `Settings.tsx` (keys), `Usage.tsx` (analytics)
- API client in `frontend/src/lib/api.ts`
- Styling: Tailwind CSS + Radix UI primitives

### Configuration

**Environment variables** (`backend/.env`):
- `ENCRYPTION_KEY` - Required for API key encryption (generate with `setup.sh`)
- `SECRET_KEY` - Session secret
- `DATABASE_URL` - Database connection (default: `sqlite:///./storage/db.sqlite`)
- `STORAGE_PATH` - Video storage directory (default: `./storage/videos`)
- `PORT` - Backend port (default: 3001)
- `CORS_ORIGINS` - Comma-separated allowed origins

**Settings class:** `backend/src/config.py` using Pydantic Settings

### Video Storage

- Videos saved to `storage/videos/` as `{generation_id}.mp4`
- Served via FastAPI StaticFiles at `/videos/{filename}`
- Download handled by `video_storage.py` with retry logic
- For OpenAI Sora, Authorization header passed during download

### Provider-Specific Notes

**OpenAI Sora:**
- Requires Bearer token in Authorization header for video downloads
- Models: `sora-2`, `sora-1`
- Supports audio generation
- Cost: $0.10/second

**Runway:**
- Models: `runway-gen3`, `runway-gen4`
- No audio support
- Credit-based pricing (estimated at $0.05-0.075/sec)

**Kling AI:**
- Models: `kling-1.5`, `kling-1.0`
- Credit-based pricing (estimated at $0.03-0.04/sec)

## Common Development Tasks

### Debugging Video Generation Issues

1. Check backend logs: `docker-compose logs -f backend`
2. Verify API key status in Settings page
3. Test provider key validation: `POST /v1/keys/{id}/validate`
4. Check `Generation` record in database for `error_message`
5. Confirm provider API is operational (check provider status pages)

### Adding Usage Tracking

- Cost automatically calculated in `process_video_generation()`
- Cost calculator uses provider + model + duration + resolution
- Extend `cost_calculator.py` to add new pricing models
- Statistics endpoints in `routes.py` starting at line 252

### Modifying API Schemas

- Request/response schemas in `backend/src/api/schemas.py`
- Use Pydantic models for validation
- Update frontend TypeScript types in `lib/api.ts` to match

### Database Migrations

- No Alembic migrations currently configured
- Schema changes require manual updates or database reset
- To reset: `rm storage/db.sqlite && docker-compose restart backend`
- For production: Implement Alembic migrations in `backend/alembic/`

## Known Limitations

- SQLite database (not suitable for high concurrency)
- Polling-based status checks (not webhook-based)
- Local file storage (not cloud-native)
- Single-instance design (no horizontal scaling)
- No authentication/authorization (single-user assumption)
- Frontend polls backend every few seconds during generation

## Production Considerations

Before deploying:
1. Change default `ENCRYPTION_KEY` and `SECRET_KEY`
2. Switch to PostgreSQL (`DATABASE_URL=postgresql://...`)
3. Use cloud storage (S3/R2) for videos
4. Enable HTTPS and update `CORS_ORIGINS`
5. Add rate limiting and authentication
6. Implement proper logging/monitoring
7. Set up backup strategy for database and videos
8. Use CDN for video delivery
9. Consider Redis for distributed task queue

## Docker Images

### Pre-built Images

Images are automatically built and pushed to GitHub Container Registry on every commit to main:

- `ghcr.io/samagra14/mediarouter-backend:latest`
- `ghcr.io/samagra14/mediarouter-frontend:latest`

**Multi-platform support:** Images are built for both `linux/amd64` and `linux/arm64` (Apple Silicon compatible).

### Image Management

```bash
# Pull latest images
docker compose pull

# Use specific version tag
docker pull ghcr.io/samagra14/mediarouter-backend:v1.0.0

# Build locally instead of pulling
docker compose -f docker-compose.local.yml up --build
```

### CI/CD

GitHub Actions workflow (`.github/workflows/docker-build.yml`) automatically:
- Builds images on push to main
- Tags with version on git tags (e.g., `v1.0.0`)
- Pushes to GitHub Container Registry
- Caches layers for faster builds
- Supports multi-platform builds (amd64/arm64)

## Code Style

- Python: FastAPI conventions, type hints, async/await patterns
- TypeScript: React functional components, hooks, TypeScript strict mode
- Follow existing patterns when adding features
- API responses follow OpenAI-compatible format where applicable
